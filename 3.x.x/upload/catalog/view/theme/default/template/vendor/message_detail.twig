{{ header }}{{ column_left }}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
      </div>
      <h1>{{ heading_titleview }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>
    <div class="container-fluid">
        {% if error_warning %}
        <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        {% endif %}
        {% if success %}
        <div class="alert alert-success"><i class="fa fa-check-circle"></i> {{ success }}
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        {% endif %}
        <div class="success_msg"></div>
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title"><i class="fa fa-list"></i> {{ text_list }}</h3>
          </div>
          <div class="panel-body messagelist">
            <div class="content msgsendform">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <td class="box1">{{ description }}</td>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <div style="overflow-x:hidden; max-height: 450px;">
                          <div class="box2">
                            <div class="comment-part box2">
                              <ul class="comment-section list">

                                <!-- All Message Start-->
                                {% for result in tmdmessage %}
                                  {% if result.customer_id %}
                                  <li class="comment user-comment">
                                    <div class="info">
                                    </div>
                                    <p class="message">
                                      <b>{{ result.message }} <span class="pull-right">{{ result.data_added }}</span></b>
                                      {% if result.filename %}
                                      <br/>
                                      <a href="{{ result.hreflink }}"><strong>{{ text_download }}</strong> </a>
                                      {% endif %}
                                    </p>
                                  </li>
                                  {% else %}
                                  <li class="comment author-comment">
                                    <div class="info">
                                    </div>
                                    <p class="message pull-right">
                                      <b>{{ result.data_added }} <span class="pull-right">{{ result.message }}
                                      {% if result.filename %}
                                      <br/>
                                      <a href="{{ result.hreflink }}"><strong>{{ text_download }}</strong> </a>
                                      {% endif %}
                                      </span></b>
                                    </p>
                                  </li>
                                  {% endif %}
                                {% endfor %}
                                <!-- All Message End-->
                                
                              </ul>
                                             
                            </div>
                          </div>
                          <div id="messagedetail"></div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              
              </div>
            </div>

            
            <div class="content msgsendform">
               <div class="table-responsive">
                  <table class="table table-hover">
                <thead>
                  <tr>
                    <td class="box1">{{ entry_reply }}</td>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <label>{{ entry_response }}</label>
                      <textarea name="message" class="form-control" col="40"  rows="10" style=" width: 100%;" id="responsetext"></textarea>
                      <div id="errormessage"></div>
                      <input type="hidden" name="inquiry_id" value="{{ inquiry_id }}">
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="col-sm-12">
                <div class="well">
                  <div class="row">
                    <div class="col-sm-3">
                      <div class="form-group">
                        <label class="control-label" for="input-upload">{{ entry_upload }}</label>
                        <input type="hidden" name="filename" value="" placeholder="{{ entry_upload }}" id="input-filename" class="form-control" />
                        <span class="input-group-btn">
                        </span>
                        <button type="button" id="button-upload" data-loading-text="{{ text_loading }}" class="btn btn-primary"><i class="fa fa-upload"></i> {{ button_upload }}</button>
                      </div>
                    </div>
                    <div class="button-group">
                      <input type="button" id="msgsend" style="margin-top:32px;margin-left:-40px;" value="{{ button_submit }}" class="button message col-sm-6" />
                    </div>    
                  </div>
                </div>
              </div>
              
            </div>
          </div>

        </div>
      </div>
    </div>
</div>
<link rel="stylesheet" type="text/css" href="catalog/view/theme/default/stylesheet/vendor/tmdmsg.css">
{{ footer }}
<script>
$(document).on('click', '#msgsend',function(){
  var noti = ($('.msgsendform input[name=\'notify\']').prop('checked') ? 1 : 0);
  $.ajax({
  url:'index.php?route=vendor/message_detail/sendDetailMessage&notify='+noti,
  data: $('.msgsendform input[type=\'text\'], .msgsendform input[type=\'hidden\'],.msgsendform textarea,.msgsendform select'),
  type:'post',
  dataType:'json',

  beforeSend: function() {
    $('.success, .warning, .alert, .alert-danger').remove();

    $('#msgsend').attr('disabled', true);
    $('#msgsend').button('loading');

  },
  complete: function() {
    $('#msgsend').button('reset');
    $('#msgsend').attr('disabled', false);
    $('.attention').remove();
  },

  success: function(json) {

    if (json['error']) {
    $('#errormessage').html('<div class="alert alert-danger">' + json['error'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');    
    }

    if (json['success']) {
      $('.success_msg').html('<div class="alert alert-success">' + json['success'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');    
      messagedetail(json);
      $('.msgsendform select').val('');
      $('#errormessage').html('');
      $('.alert alert-success').html('');
      $('.msgsendform input[name=\'notify\']').attr('checked', false);
      $('#responsetext').val('');
    }
  }
});
});

function messagedetail(json){
  html='';
  html+='<div class="box2">';
  html+='<ul class="comment-section">';
  html+='<li class="comment author-comment">';
  html+='<div class="info">'; 
  html+='</div>';
  html+='<p class="message pull-right"><b>'+json['date_added']+'</b><b><span class="pull-right">'+json['message']+'</b>';
  if(json['filename']) {
  html+='<br/>';
  html+='<a href="'+json['hreflink']+'" class="pull-right"><strong>{{ text_download }} </strong> </a>';
  }
  html+='</span></p>';
  html+='</li>';
  html+='</ul>';
  html+='</div>';
  $('#messagedetail').append(html);
}
</script>
<script type="text/javascript"><!--
$('#button-upload').on('click', function() {
  $('#form-upload').remove();

  $('body').prepend('<form enctype="multipart/form-data" id="form-upload" style="display: none;"><input type="file" name="file" /></form>');

  $('#form-upload input[name=\'file\']').trigger('click');

  if (typeof timer != 'undefined') {
      clearInterval(timer);
  }

  timer = setInterval(function() {
    if ($('#form-upload input[name=\'file\']').val() != '') {
      clearInterval(timer);

      $.ajax({
        url: 'index.php?route=vendor/message_detail/upload',
        type: 'post',
        dataType: 'json',
        data: new FormData($('#form-upload')[0]),
        cache: false,
        contentType: false,
        processData: false,
        beforeSend: function() {
          $('#button-upload').button('loading');
        },
        complete: function() {
          $('#button-upload').button('reset');
        },
        success: function(json) {
          if (json['error']) {
            alert(json['error']);
          }

          if (json['success']) {
            alert(json['success']);
            $('input[name=\'filename\']').val(json['filename']);
          }
        },
        error: function(xhr, ajaxOptions, thrownError) {
          alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
      });
    }
  }, 500);
});
//--></script>

